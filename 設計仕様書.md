# DXニュース自動収集・配信アプリ 設計仕様書

## 目次

1. [はじめに](#1-はじめに)
2. [システム概要](#2-システム概要)
3. [機能要件](#3-機能要件)
4. [非機能要件](#4-非機能要件)
5. [システム構成](#5-システム構成)
6. [データフロー](#6-データフロー)
7. [モジュール詳細設計](#7-モジュール詳細設計)
8. [インターフェース仕様](#8-インターフェース仕様)
9. [エラー処理](#9-エラー処理)
10. [セキュリティ](#10-セキュリティ)
11. [運用・保守](#11-運用保守)
12. [用語集](#12-用語集)
13. [付録](#13-付録)

---

## 1. はじめに

### 1.1 本書の目的

本書は、「DXニュース自動収集・配信アプリ」の設計仕様を記述したものです。システムの開発者、運用者、および利用者が、システムの仕組みや動作を理解できるように、技術的な知識がない方でも理解できるよう詳細に記載しています。

### 1.2 想定読者

- **システム管理者**: アプリケーションの設定・運用を行う方
- **開発者**: システムの保守・改修を行う方
- **経営者・マネージャー**: システム導入の意思決定を行う方
- **一般利用者**: 配信されたニュースを受け取る方

### 1.3 記法について

本書では以下の記法を使用します：

- 📌 **重要**: 特に注意が必要な事項
- 💡 **ヒント**: 知っておくと便利な情報
- ⚠️ **注意**: 誤った操作を防ぐための警告
- 🔧 **技術詳細**: 開発者向けの詳細情報

---

## 2. システム概要

### 2.1 システムの目的

#### 2.1.1 背景と課題

現代のビジネス環境では、以下の課題があります：

1. **情報過多の問題**
   - インターネット上には膨大な情報が溢れている
   - 重要な情報を見逃すリスクがある
   - 情報収集に多大な時間がかかる

2. **情報共有の非効率性**
   - チーム内での情報共有が属人化している
   - 同じ情報を複数人が別々に収集している
   - タイムリーな情報共有ができていない

3. **デジタルトランスフォーメーション（DX）の必要性**
   - 企業のDX推進には最新技術動向の把握が不可欠
   - 生成AI、BIツールなどの技術革新が急速
   - 競合他社の動向を常に把握する必要がある

#### 2.1.2 ソリューション

本システムは、これらの課題を解決するために開発されました：

- **自動収集**: 複数の情報源から自動的にニュースを収集
- **インテリジェントな選別**: AIを活用して重要な情報だけを抽出
- **効率的な配信**: チーム全体に一括で情報を配信
- **SNS活用**: 企業の情報発信力を強化

### 2.2 システムの特徴

#### 2.2.1 主要な特徴

1. **完全自動化**
   - 人手を介さずに情報収集から配信まで自動実行
   - スケジュール設定により定期的に実行
   - 24時間365日稼働可能

2. **AI活用**
   - OpenAI社の最新AI技術（GPT-4o mini）を活用
   - 高品質な要約文の自動生成
   - 文脈を理解した適切なコンテンツ生成

3. **マルチプラットフォーム対応**
   - Microsoft Teams（社内共有）
   - Twitter/X（外部発信）
   - note（詳細記事）

4. **カスタマイズ性**
   - 収集するキーワードを自由に設定可能
   - 配信時間を業務に合わせて調整可能
   - 情報源（RSSフィード）を追加・変更可能

#### 2.2.2 期待される効果

- **時間削減**: 情報収集時間を1日2時間→0分に
- **情報の質向上**: AIによる重要情報の選別
- **チーム生産性向上**: 全員が同じ情報を共有
- **ブランディング強化**: SNSでの情報発信

### 2.3 システム利用イメージ

#### 2.3.1 典型的な利用シナリオ

```
【月曜日 朝9:00】
1. システムが自動起動
2. 各種ニュースサイトから最新記事を収集（約5分）
3. AIが記事を分析・要約（約3分）
4. Teams に要約を投稿
5. 社員がTeamsで最新ニュースを確認
6. 重要なトピックについてTwitter/noteで発信（オプション）
```

#### 2.3.2 利用者別のメリット

**経営層**
- DX関連の最新動向を効率的に把握
- 競合他社の動きを見逃さない
- 戦略立案の判断材料を入手

**マーケティング部門**
- SNS発信のネタを自動生成
- トレンドに即した情報発信
- ブランド認知度の向上

**開発部門**
- 最新技術トレンドの把握
- 新技術の学習機会の発見
- 技術選定の参考情報

**一般社員**
- 業界動向の理解
- 社内での話題作り
- スキルアップの機会発見

---

## 3. 機能要件

### 3.1 機能一覧

本システムは以下の機能を提供します：

| 機能カテゴリ | 機能名 | 概要 | 優先度 |
|------------|--------|------|--------|
| 情報収集 | RSS収集機能 | 複数のRSSフィードから記事を取得 | 必須 |
| 情報収集 | キーワードフィルタ | 指定キーワードで記事を絞り込み | 必須 |
| 情報収集 | 期間フィルタ | 指定期間内の記事のみ取得 | 必須 |
| 情報処理 | 重複除去 | 類似記事をクラスタリング | 必須 |
| 情報処理 | AI要約 | 記事を200字以内に要約 | 必須 |
| 情報処理 | コンテンツ生成 | Twitter/note向け文章生成 | 必須 |
| 配信 | Teams通知 | Markdown形式で通知 | 必須 |
| 配信 | Twitter投稿 | 280字以内のツイート | オプション |
| 配信 | note投稿 | 800-1200字の記事 | オプション |
| 実行制御 | スケジュール実行 | 指定曜日・時刻に自動実行 | 必須 |
| 実行制御 | 手動実行 | コマンドで即時実行 | 必須 |

### 3.2 機能詳細

#### 3.2.1 RSS収集機能

**目的**: 複数のニュースサイトから効率的に最新記事を収集する

**詳細仕様**:
- **入力**: RSS フィードのURL（複数可）
- **処理**: 
  1. 各URLにHTTPリクエストを送信
  2. XML形式のRSSデータを取得
  3. 記事情報（タイトル、リンク、概要、公開日）を抽出
- **出力**: 記事情報のリスト

**設定例**:
```
RSS_FEEDS=https://example.com/rss,https://news.site/feed
```

💡 **ヒント**: RSS（Really Simple Syndication）は、ウェブサイトの更新情報を配信する仕組みです。多くのニュースサイトがRSSフィードを提供しています。

#### 3.2.2 キーワードフィルタ機能

**目的**: 関心のあるトピックの記事だけを抽出する

**詳細仕様**:
- **入力**: キーワードリスト（カンマ区切り）
- **処理**:
  1. 各記事のタイトルと概要を検査
  2. キーワードが含まれているか確認（大文字小文字を区別しない）
  3. いずれかのキーワードが含まれる記事を選択
- **出力**: フィルタ済み記事リスト

**キーワード例**:
- 生成AI
- BIツール
- DX
- デジタルトランスフォーメーション
- ChatGPT
- データ分析

#### 3.2.3 期間フィルタ機能

**目的**: 古い記事を除外し、最新情報のみを扱う

**詳細仕様**:
- **デフォルト期間**: 7日間
- **処理**:
  1. 現在日時を基準に指定日数前の日時を計算
  2. 各記事の公開日時と比較
  3. 期間内の記事のみを選択
- **タイムゾーン**: UTC（協定世界時）で処理

📌 **重要**: 期間を長くしすぎると、処理時間が増加し、古い情報が混在する可能性があります。

#### 3.2.4 重複除去機能（クラスタリング）

**目的**: 同じニュースの重複配信を防ぐ

**詳細仕様**:
- **アルゴリズム**: 文字列類似度計算（SequenceMatcher）
- **類似度閾値**: 0.8（80%以上類似）
- **処理**:
  1. 全記事のタイトルを比較
  2. 類似度が閾値以上の記事をグループ化
  3. 各グループから代表記事（最初の記事）を選択

**例**: 以下のような記事は同一グループとして扱われます
- 「OpenAI、新AI モデル GPT-5 を発表」
- 「OpenAI が新 AI モデル GPT-5 を公開」
- 「GPT-5：OpenAI の最新 AI モデルが登場」

#### 3.2.5 AI要約機能

**目的**: 長い記事を短時間で理解できるようにする

**詳細仕様**:
- **使用AI**: OpenAI GPT-4o mini
- **要約文字数**: 200字以内
- **要約ポイント**:
  - 記事の主要な内容
  - ビジネスへの影響
  - 重要な数値や日付
- **言語**: 日本語

**要約例**:
```
元記事（1000字）→ 要約（200字）
「マイクロソフトは本日、新しいAI搭載オフィススイートを発表...（長文）」
↓
「マイクロソフトが AI 搭載の新オフィススイートを発表。Word や Excel に GPT-4 を統合し、文書作成や データ分析を自動化。月額 $30 で提供開始。企業の生産性を最大 40% 向上させると発表。」
```

#### 3.2.6 コンテンツ生成機能

**目的**: SNS投稿用のコンテンツを自動作成する

**Twitter向け（280字以内）**:
- ハッシュタグ2-3個を含む
- 読者の関心を引く書き出し
- 簡潔で分かりやすい表現

**note向け（800-1200字）**:
- 導入・本文・結論の構成
- 詳細な解説
- ビジネスへの示唆

#### 3.2.7 Teams通知機能

**目的**: チーム全体に情報を共有する

**詳細仕様**:
- **配信先**: Microsoft Teams のチャネル
- **形式**: Markdown
- **内容**:
  - 日付入りヘッダー
  - 記事リスト（リンク付き）
  - 各記事の要約

**表示例**:
```markdown
## DXニュースまとめ (2024-01-15)
- [OpenAI、GPT-5を発表](https://example.com/news/1) — OpenAIが次世代AI「GPT-5」を発表。従来比10倍の性能向上を実現。
- [Microsoft、AI統合Office公開](https://example.com/news/2) — Word、ExcelにGPT-4を統合。月額$30で提供開始。
```

#### 3.2.8 実行制御機能

**スケジュール実行**:
- 曜日指定: 月曜日〜日曜日
- 時刻指定: 00:00〜23:59（24時間制）
- 実行間隔: 週1回

**手動実行**:
```bash
# 即時実行（配信のみ）
python main.py --run-now

# 即時実行（SNS投稿も実行）
python main.py --run-now --post
```

---

## 4. 非機能要件

### 4.1 性能要件

#### 4.1.1 処理時間

| 処理 | 想定時間 | 最大許容時間 |
|------|---------|-------------|
| RSS収集（10フィード） | 30秒 | 2分 |
| フィルタリング（100記事） | 1秒 | 5秒 |
| AI要約（20記事） | 2分 | 5分 |
| Teams通知 | 2秒 | 10秒 |
| 全体処理 | 5分 | 10分 |

#### 4.1.2 処理能力

- **同時RSS取得**: 最大10フィード
- **処理可能記事数**: 最大500記事/回
- **要約生成**: 最大50記事/回

### 4.2 可用性要件

- **稼働率目標**: 99%（月間停止時間：約7時間以内）
- **計画停止**: 月1回、深夜帯でのメンテナンス
- **障害復旧**: 手動再起動により復旧可能

### 4.3 運用性要件

- **ログ出力**: 全処理のログを記録
- **設定変更**: 環境変数の変更で対応（再起動必要）
- **監視**: ログファイルによる事後確認

### 4.4 セキュリティ要件

- **認証情報の保護**: 環境変数での管理
- **通信の暗号化**: HTTPS通信の使用
- **アクセス制御**: APIキーによる認証

### 4.5 保守性要件

- **コード品質**: PEP 8準拠のPythonコード
- **モジュール構造**: 機能ごとに分離
- **ドキュメント**: コード内コメント、README、本仕様書

### 4.6 移植性要件

- **動作環境**: Python 3.12以上
- **OS**: Windows、Linux、macOS対応
- **依存関係**: requirements.txtで管理

---

## 5. システム構成

### 5.1 システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    外部サービス層                          │
├─────────────┬─────────────┬──────────────┬──────────────┤
│   RSS       │  OpenAI     │   Teams     │ Twitter/note │
│  Feeds      │   API       │  Webhook    │    API       │
└──────┬──────┴──────┬───────┴──────┬───────┴──────┬───────┘
       │             │              │              │
       ▼             ▼              ▼              ▼
┌─────────────────────────────────────────────────────────┐
│                 DXニュース収集・配信アプリ                  │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   main.py   │  │  config.py   │  │requirements  │  │
│  │  (メイン)    │  │   (設定)      │  │    .txt      │  │
│  └──────┬──────┘  └──────────────┘  └──────────────┘  │
│         │                                                │
│  ┌──────▼───────────────────────────────────────────┐   │
│  │                  utils/ (ユーティリティ)            │   │
│  ├──────────────┬─────────────┬────────────────────┤   │
│  │   rss.py     │clustering.py│     llm.py         │   │
│  │ (RSS収集)    │ (重複除去)   │   (AI処理)         │   │
│  ├──────────────┼─────────────┼────────────────────┤   │
│  │  teams.py    │twitter.py   │    note.py         │   │
│  │ (Teams通知)  │(Twitter投稿) │  (note投稿)        │   │
│  └──────────────┴─────────────┴────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 5.2 モジュール構成

#### 5.2.1 メインモジュール

**main.py**
- 役割: アプリケーションのエントリーポイント
- 責務:
  - コマンドライン引数の解析
  - 処理フローの制御
  - スケジューラーの管理

**config.py**
- 役割: 設定情報の一元管理
- 責務:
  - 環境変数の読み込み
  - 設定値の検証
  - デフォルト値の提供

#### 5.2.2 ユーティリティモジュール

**utils/rss.py**
- 役割: RSS フィードの処理
- 主要関数:
  - `parse_rss_feed()`: 単一フィードの解析
  - `filter_by_keywords()`: キーワードフィルタ
  - `fetch_articles()`: 統合取得関数

**utils/clustering.py**
- 役割: 記事の重複除去
- 主要関数:
  - `_similarity()`: 類似度計算
  - `cluster_articles()`: クラスタリング実行

**utils/llm.py**
- 役割: AI処理の実行
- 主要クラス:
  - `LLMClient`: OpenAI APIクライアント
- 主要メソッド:
  - `summarize()`: 要約生成
  - `generate_tweet()`: ツイート生成
  - `generate_note_article()`: note記事生成

**utils/teams.py**
- 役割: Teams への通知
- 主要関数:
  - `send_to_teams()`: Webhook経由での送信

**utils/twitter.py**
- 役割: Twitter への投稿
- 主要関数:
  - `post_to_twitter()`: API v2での投稿

**utils/note.py**
- 役割: note への投稿
- 主要関数:
  - `post_to_note()`: 記事投稿

### 5.3 外部依存関係

#### 5.3.1 Pythonパッケージ

| パッケージ | バージョン | 用途 | 必須/オプション |
|-----------|----------|------|----------------|
| feedparser | >=6.0 | RSS解析 | 必須 |
| python-dotenv | >=1.0 | 環境変数管理 | 必須 |
| openai | >=1.0 | AI API | 必須 |
| requests | >=2.31 | HTTP通信 | 必須 |
| schedule | >=1.2 | スケジュール実行 | 必須 |

#### 5.3.2 外部サービス

**必須サービス**:
1. **OpenAI API**
   - 用途: 記事要約、コンテンツ生成
   - 料金: 従量課金（約 $0.002/1000トークン）
   - 必要な権限: APIキー

2. **Microsoft Teams**
   - 用途: チーム内通知
   - 料金: 組織のTeamsライセンスに含まれる
   - 必要な設定: Incoming Webhook

**オプションサービス**:
1. **Twitter API v2**
   - 用途: ツイート投稿
   - 料金: 基本プラン $100/月〜
   - 必要な権限: Bearer Token

2. **note API**
   - 用途: 記事投稿
   - 料金: 要問い合わせ
   - 必要な権限: アクセストークン

---

## 6. データフロー

### 6.1 全体フロー

```
[開始]
  │
  ▼
[設定読み込み] ← .env ファイル
  │
  ▼
[実行モード判定]
  │
  ├─ スケジュール実行 → [指定時刻まで待機]
  │                      │
  └─ 即時実行 ──────────┘
                         │
                         ▼
                    [メイン処理開始]
                         │
  ┌──────────────────────┼──────────────────────┐
  ▼                      ▼                      ▼
[RSS収集]          [RSS収集]            [RSS収集]
(フィード1)        (フィード2)          (フィードN)
  │                      │                      │
  └──────────────────────┴──────────────────────┘
                         │
                         ▼
                   [記事統合・重複除去]
                         │
                         ▼
                   [キーワードフィルタ]
                         │
                         ▼
                   [クラスタリング]
                         │
                         ▼
                   [AI要約生成] → OpenAI API
                         │
                         ▼
                   [Teams通知] → Teams Webhook
                         │
                         ▼
                   [トピック選定]
                         │
                         ▼
                [コンテンツ生成] → OpenAI API
                         │
                         ├─ [Twitter投稿] → Twitter API
                         │   (--postオプション時)
                         │
                         └─ [note投稿] → note API
                             (--postオプション時)
                         
[終了]
```

### 6.2 データ変換フロー

#### 6.2.1 RSS データの変換

```
[RSS XML データ]
    │
    ▼ feedparser
[Python 辞書形式]
{
  "title": "記事タイトル",
  "link": "https://...",
  "published": datetime,
  "summary": "記事概要..."
}
    │
    ▼ フィルタリング
[フィルタ済みリスト]
    │
    ▼ クラスタリング
[クラスタ配列]
[[記事1, 類似記事1], [記事2], ...]
```

#### 6.2.2 要約データの生成

```
[元記事テキスト]
"マイクロソフトは本日..."（1000字）
    │
    ▼ OpenAI API
[要約テキスト]
"マイクロソフトがAI搭載..."（200字）
    │
    ▼ Markdown 変換
[Teams 投稿形式]
"- [タイトル](URL) — 要約"
```

### 6.3 エラー時のフロー

```
[エラー発生]
    │
    ├─ RSS取得エラー → [該当フィードをスキップ] → [処理継続]
    │
    ├─ AI APIエラー → [リトライ(3回)] → [失敗時は元テキスト使用]
    │
    ├─ Teams通知エラー → [ログ出力] → [処理継続]
    │
    └─ 致命的エラー → [ログ出力] → [処理中断]
```

---

## 7. モジュール詳細設計

### 7.1 main.py（メインモジュール）

#### 7.1.1 概要

アプリケーションの中心となるモジュールで、全体の処理フローを制御します。

#### 7.1.2 主要関数

**setup_logging()**
```python
def setup_logging() -> None:
    """基本的なロギング設定を行う。"""
```
- 目的: ログ出力の初期設定
- 処理: ログレベル、フォーマット、出力先の設定
- 出力形式: `時刻 [レベル] モジュール名: メッセージ`

**strip_html_tags(text: str) -> str**
```python
def strip_html_tags(text: str) -> str:
    """HTML タグを簡易的に除去し、生のテキストを返す。"""
```
- 目的: RSS概要に含まれるHTMLタグの除去
- 処理: 正規表現でタグを削除、HTMLエンティティをデコード
- 例: `<p>本文</p>` → `本文`

**build_markdown(clusters, summaries) -> str**
```python
def build_markdown(clusters: List[List[Dict[str, str]]], 
                  summaries: Dict[str, str]) -> str:
    """Teams へ送信する Markdown メッセージを組み立てる。"""
```
- 目的: Teams投稿用のMarkdown生成
- 入力: クラスタリング済み記事、要約辞書
- 出力: Markdown形式の文字列

**select_topic_clusters(clusters, max_topics=5)**
```python
def select_topic_clusters(clusters: List[List[Dict[str, str]]], 
                         max_topics: int = 5) -> List[List[Dict[str, str]]]:
    """トピック候補クラスタを選択する。"""
```
- 目的: SNS投稿用の重要トピック選定
- 選定基準:
  1. クラスタサイズ（記事数）の多い順
  2. 最新の公開日時を持つ順
- 出力: 最大5つのクラスタ

**run_task(config, post)**
```python
def run_task(config: Config, post: bool) -> None:
    """ニュース取得から要約、投稿生成、Teams への通知を実行する。"""
```
- 目的: メイン処理の実行
- 処理フロー:
  1. RSS記事取得
  2. クラスタリング
  3. 各記事の要約生成
  4. Teams通知
  5. トピック選定とSNSコンテンツ生成
  6. オプションでSNS投稿

**schedule_tasks(config, post)**
```python
def schedule_tasks(config: Config, post: bool) -> None:
    """schedule ライブラリを利用して指定曜日・時刻にタスクを実行する。"""
```
- 目的: 定期実行の設定
- 処理: 
  - 曜日と時刻を設定
  - 60秒ごとにスケジュールチェック
  - 該当時刻で`run_task`を実行

#### 7.1.3 エラーハンドリング

| エラー種別 | 処理方法 | 影響範囲 |
|-----------|---------|---------|
| RSS取得失敗 | ログ出力後、処理継続 | 該当フィードのみ |
| 要約生成失敗 | 元テキストを使用 | 該当記事のみ |
| Teams通知失敗 | ログ出力後、処理継続 | 通知のみ |
| 設定読込失敗 | プログラム終了 | 全体 |

### 7.2 config.py（設定管理モジュール）

#### 7.2.1 概要

環境変数から設定を読み込み、アプリケーション全体で使用する設定情報を管理します。

#### 7.2.2 Configクラス

```python
@dataclass
class Config:
    """アプリケーション設定を保持するデータクラス。"""
    openai_api_key: str          # 必須
    team_webhook_url: str        # 必須
    twitter_bearer_token: str | None = None  # オプション
    note_token: str | None = None            # オプション
    post_day_of_week: str = "mon"
    post_hour_24: str = "09"
    rss_feeds: List[str] = field(default_factory=list)
    keywords: List[str] = field(default_factory=list)
```

#### 7.2.3 環境変数マッピング

| 環境変数名 | 設定項目 | 必須/オプション | デフォルト値 |
|-----------|---------|----------------|------------|
| OPENAI_API_KEY | OpenAI APIキー | 必須 | - |
| TEAM_WEBHOOK_URL | Teams Webhook URL | 必須 | - |
| TWITTER_BEARER_TOKEN | Twitter認証トークン | オプション | None |
| NOTE_TOKEN | noteアクセストークン | オプション | None |
| POST_DAY_OF_WEEK | 実行曜日 | オプション | mon |
| POST_HOUR_24 | 実行時刻 | オプション | 09 |
| RSS_FEEDS | RSSフィードURL | オプション | 空リスト |
| KEYWORDS | フィルタキーワード | オプション | 生成AI,BIツール,DX |

#### 7.2.4 設定例（.envファイル）

```bash
# 必須設定
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
TEAM_WEBHOOK_URL=https://outlook.office.com/webhook/xxxxx

# オプション設定
TWITTER_BEARER_TOKEN=AAAAAAAAAxxxxxxxxxx
NOTE_TOKEN=note_xxxxxxxxxxxxx

# 実行スケジュール
POST_DAY_OF_WEEK=mon
POST_HOUR_24=09

# RSS フィード（カンマ区切り）
RSS_FEEDS=https://techcrunch.com/feed/,https://gigazine.net/news/rss_2.0/

# キーワード（カンマ区切り）
KEYWORDS=生成AI,BIツール,DX,ChatGPT,データ分析
```

### 7.3 utils/rss.py（RSS処理モジュール）

#### 7.3.1 概要

RSSフィードから記事を取得し、フィルタリングを行うモジュールです。

#### 7.3.2 主要関数詳細

**parse_rss_feed(url, since)**
```python
def parse_rss_feed(url: str, since: datetime) -> List[Dict[str, str]]:
    """単一の RSS フィード URL から記事を取得する。"""
```

処理詳細:
1. feedparserでRSSを解析
2. 公開日時の抽出（published_parsed または updated_parsed）
3. 期間チェック（since以降の記事のみ）
4. 必要情報の抽出（title, link, published, summary）

エラー処理:
- ネットワークエラー: 空リストを返す
- 解析エラー: 該当エントリをスキップ

**filter_by_keywords(articles, keywords)**
```python
def filter_by_keywords(articles: List[Dict[str, str]], 
                      keywords: List[str]) -> List[Dict[str, str]]:
    """記事リストからキーワードが含まれるものだけを抽出する。"""
```

処理詳細:
1. キーワードを小文字に変換
2. 各記事のタイトル＋概要を結合
3. 大文字小文字を区別せずに検索
4. いずれかのキーワードが含まれれば選択

最適化:
- キーワードなしの場合は元リストをそのまま返す
- 文字列の結合は1回のみ実行

### 7.4 utils/clustering.py（クラスタリングモジュール）

#### 7.4.1 概要

類似記事をグループ化し、重複を排除するモジュールです。

#### 7.4.2 アルゴリズム詳細

**類似度計算**
```python
def _similarity(a: str, b: str) -> float:
    """タイトル同士の類似度を返す関数。"""
```

- 使用アルゴリズム: SequenceMatcher（レーベンシュタイン距離ベース）
- 返値: 0.0（完全不一致）〜 1.0（完全一致）

**クラスタリング処理**
```python
def cluster_articles(articles: List[Dict[str, str]], 
                    threshold: float = 0.8) -> List[List[Dict[str, str]]]:
    """記事リストをタイトル類似度でクラスタリングする。"""
```

アルゴリズム:
1. 全記事に未訪問フラグを設定
2. 各未訪問記事に対して:
   - 新しいクラスタを作成
   - 残りの記事との類似度を計算
   - 閾値以上の記事を同じクラスタに追加
3. 全クラスタを返す

計算量: O(n²)（nは記事数）

### 7.5 utils/llm.py（AI処理モジュール）

#### 7.5.1 概要

OpenAI APIを使用して、記事の要約やコンテンツ生成を行うモジュールです。

#### 7.5.2 LLMClientクラス

**初期化**
```python
def __init__(self, api_key: str, model: str = "gpt-4o-mini") -> None:
```
- APIキーの設定
- 使用モデルの指定（デフォルト: gpt-4o-mini）

**共通処理（_chat）**
```python
def _chat(self, messages: List[dict], max_tokens: int = 512, 
          temperature: float = 0.7, retries: int = 3) -> str:
```

パラメータ:
- messages: ChatGPT形式のメッセージリスト
- max_tokens: 生成する最大トークン数
- temperature: 創造性の制御（0.0=決定的、1.0=創造的）
- retries: リトライ回数

リトライ戦略:
- Rate Limit エラー: 指数バックオフ（2^n秒待機）
- その他のエラー: 1秒待機後リトライ

#### 7.5.3 各生成メソッド

**summarize（要約生成）**
- 最大文字数: 200字
- Temperature: 0.3（より正確性重視）
- プロンプト: 編集者として要約を作成

**generate_tweet（ツイート生成）**
- 最大文字数: 280字
- Temperature: 0.7（バランス型）
- 含める要素: ハッシュタグ2-3個

**generate_note_article（記事生成）**
- 文字数範囲: 800-1200字
- Temperature: 0.7（バランス型）
- 構成: イントロ・本文・結論

### 7.6 配信モジュール（teams.py, twitter.py, note.py）

#### 7.6.1 共通仕様

全配信モジュールの共通仕様:
- HTTP通信にrequestsライブラリを使用
- タイムアウト: 10秒
- エラー時は例外を発生
- 成功時はログ出力

#### 7.6.2 teams.py

**Webhook仕様**:
- エンドポイント: Teamsで生成されたURL
- メソッド: POST
- Content-Type: application/json
- ペイロード: `{"text": "Markdown文字列"}`

#### 7.6.3 twitter.py

**API仕様**:
- エンドポイント: https://api.twitter.com/2/tweets
- 認証: Bearer Token
- ペイロード: `{"text": "ツイート本文"}`
- 制限: 280字以内

⚠️ **注意**: Twitter API v2の有料プランが必要

#### 7.6.4 note.py

**API仕様**:
- エンドポイント: https://note.com/api/v1/notes（仮）
- 認証: Bearer Token
- ペイロード: `{"title": "タイトル", "text": "本文"}`

📌 **重要**: note APIの正式な仕様は公式ドキュメントを参照

---

## 8. インターフェース仕様

### 8.1 コマンドラインインターフェース

#### 8.1.1 基本構文

```bash
python main.py [オプション]
```

#### 8.1.2 オプション一覧

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| --run-now | 即時実行（スケジュールを無視） | False |
| --post | SNS投稿を実行 | False |
| --help, -h | ヘルプを表示 | - |

#### 8.1.3 実行例

```bash
# スケジュール実行を開始
python main.py

# 即時実行（配信のみ）
python main.py --run-now

# 即時実行（SNS投稿も含む）
python main.py --run-now --post

# ヘルプ表示
python main.py --help
```

### 8.2 環境変数インターフェース

#### 8.2.1 設定方法

1. `.env`ファイルを作成
2. 必要な環境変数を記載
3. プログラム実行時に自動読み込み

#### 8.2.2 設定確認方法

```bash
# 環境変数の確認（Linux/Mac）
cat .env

# 環境変数の確認（Windows）
type .env
```

### 8.3 外部APIインターフェース

#### 8.3.1 OpenAI API

**リクエスト形式**:
```json
{
  "model": "gpt-4o-mini",
  "messages": [
    {"role": "system", "content": "システムプロンプト"},
    {"role": "user", "content": "ユーザープロンプト"}
  ],
  "max_tokens": 512,
  "temperature": 0.7
}
```

**レスポンス形式**:
```json
{
  "choices": [{
    "message": {
      "content": "生成されたテキスト"
    }
  }]
}
```

#### 8.3.2 Teams Incoming Webhook

**リクエスト形式**:
```json
{
  "text": "## タイトル\n- 項目1\n- 項目2"
}
```

**成功レスポンス**: 
- ステータスコード: 200
- ボディ: "1"

#### 8.3.3 Twitter API v2

**リクエスト形式**:
```json
{
  "text": "ツイート本文 #ハッシュタグ"
}
```

**成功レスポンス**:
```json
{
  "data": {
    "id": "1234567890",
    "text": "ツイート本文 #ハッシュタグ"
  }
}
```

---

## 9. エラー処理

### 9.1 エラー分類

#### 9.1.1 エラーレベル

| レベル | 説明 | 処理継続 | 例 |
|--------|------|---------|---|
| CRITICAL | 致命的エラー | 不可 | 設定ファイル読込失敗 |
| ERROR | エラー | 部分的に可 | API呼び出し失敗 |
| WARNING | 警告 | 可 | 一部記事の解析失敗 |
| INFO | 情報 | - | 正常処理の記録 |

#### 9.1.2 エラー種別と対処

**ネットワークエラー**
- 原因: インターネット接続不良、サーバーダウン
- 対処: リトライ処理、該当処理のスキップ
- ユーザーへの影響: 一部記事の欠落

**認証エラー**
- 原因: APIキーの期限切れ、無効なトークン
- 対処: エラーログ出力、処理中断
- ユーザーへの影響: 機能の完全停止

**データ形式エラー**
- 原因: 予期しないRSS形式、文字コード問題
- 対処: 該当データのスキップ
- ユーザーへの影響: 一部記事の欠落

**レート制限エラー**
- 原因: API呼び出し回数の超過
- 対処: 待機後リトライ
- ユーザーへの影響: 処理時間の延長

### 9.2 エラーメッセージ

#### 9.2.1 ユーザー向けメッセージ

```
[ERROR] 設定の読み込みに失敗しました。必須環境変数を確認してください。
→ 対処: .envファイルの作成と必須項目の設定

[ERROR] RSS の取得に失敗しました: ネットワークエラー
→ 対処: インターネット接続の確認

[ERROR] OpenAI API 呼び出しに失敗しました: 認証エラー
→ 対処: APIキーの確認と更新

[WARNING] 一部の記事で要約生成に失敗しました
→ 対処: ログを確認（処理は継続）
```

#### 9.2.2 開発者向けログ

```
2024-01-15 09:00:00 [INFO] main: ニュース取得を開始します。
2024-01-15 09:00:01 [INFO] rss: RSS 取得中: https://example.com/feed
2024-01-15 09:00:05 [ERROR] rss: RSS フィードの取得に失敗しました: ConnectionError
2024-01-15 09:00:05 [DEBUG] clustering: 類似度計算に失敗: ValueError
2024-01-15 09:00:10 [INFO] teams: Teams へ通知しました。ステータスコード: 200
```

### 9.3 リカバリー処理

#### 9.3.1 自動リカバリー

**リトライ処理**:
- OpenAI API: 最大3回、指数バックオフ
- HTTP通信: タイムアウト10秒
- 部分的失敗: 該当部分をスキップして継続

**フォールバック**:
- 要約生成失敗 → 元テキストの先頭200字を使用
- RSS取得失敗 → 該当フィードをスキップ
- クラスタリング失敗 → クラスタリングなしで処理

#### 9.3.2 手動リカバリー

**プロセス再起動**:
```bash
# プロセスの確認
ps aux | grep main.py

# プロセスの停止
kill [プロセスID]

# 再起動
python main.py
```

**ログ確認**:
```bash
# 最新のエラーログを確認
grep ERROR app.log | tail -20

# 特定時刻のログを確認
grep "2024-01-15 09:" app.log
```

---

## 10. セキュリティ

### 10.1 認証情報の管理

#### 10.1.1 保存方法

**推奨事項**:
- ✅ 環境変数での管理
- ✅ .envファイルの使用（.gitignoreに追加）
- ❌ ソースコードへの直接記載
- ❌ 設定ファイルのバージョン管理

**設定例**:
```bash
# .gitignore
.env
*.log
__pycache__/
venv/
```

#### 10.1.2 アクセス権限

**ファイル権限設定**（Linux/Mac）:
```bash
# .envファイルの権限を制限
chmod 600 .env

# 実行ファイルの権限
chmod 755 main.py
```

### 10.2 通信セキュリティ

#### 10.2.1 暗号化通信

全ての外部通信でHTTPSを使用:
- RSS取得: HTTPS対応フィードを推奨
- API通信: 全てHTTPS必須
- Webhook: HTTPS URLのみ対応

#### 10.2.2 認証方式

| サービス | 認証方式 | セキュリティレベル |
|---------|---------|------------------|
| OpenAI | APIキー | 高（定期更新推奨） |
| Teams | Webhook URL | 中（URL漏洩に注意） |
| Twitter | Bearer Token | 高（権限管理必須） |
| note | アクセストークン | 高（最小権限原則） |

### 10.3 データ保護

#### 10.3.1 個人情報の扱い

- 収集データ: 公開されているニュース記事のみ
- 保存期間: メモリ上のみ（永続化なし）
- 外部送信: 要約生成時のみ（OpenAI）

#### 10.3.2 ログ管理

**ログに含めない情報**:
- APIキー、トークン
- 個人を特定できる情報
- 機密性の高いURL

**ログローテーション**:
```bash
# 推奨設定（logrotate）
/var/log/dx-news/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

### 10.4 脆弱性対策

#### 10.4.1 入力検証

- RSS URL: 正規表現でバリデーション
- 環境変数: 必須項目のチェック
- API レスポンス: 型チェックとサニタイズ

#### 10.4.2 依存関係の管理

**定期的な更新**:
```bash
# 脆弱性チェック
pip-audit

# パッケージ更新
pip install --upgrade -r requirements.txt
```

**最小権限の原則**:
- 各APIトークンは必要最小限の権限のみ付与
- 読み取り専用の操作を基本とする

---

## 11. 運用・保守

### 11.1 初期セットアップ

#### 11.1.1 環境構築手順

**1. Python環境の準備**
```bash
# Python 3.12のインストール確認
python3 --version

# 仮想環境の作成
python3.12 -m venv venv

# 仮想環境の有効化（Linux/Mac）
source venv/bin/activate

# 仮想環境の有効化（Windows）
venv\Scripts\activate
```

**2. 依存パッケージのインストール**
```bash
pip install -r requirements.txt
```

**3. 設定ファイルの作成**
```bash
# .envファイルのサンプルをコピー
cp .env.example .env

# 設定を編集
nano .env  # またはお好みのエディタ
```

**4. 動作確認**
```bash
# 設定の確認（ドライラン）
python main.py --run-now

# ログの確認
tail -f app.log
```

#### 11.1.2 各種トークンの取得方法

**OpenAI APIキー**:
1. https://platform.openai.com にアクセス
2. アカウント作成/ログイン
3. API Keys → Create new secret key
4. 生成されたキーをコピー

**Teams Webhook URL**:
1. Teamsでチャネルを開く
2. ・・・メニュー → コネクタ
3. Incoming Webhook を追加
4. 名前を設定して作成
5. WebhookのURLをコピー

**Twitter Bearer Token**:
1. https://developer.twitter.com にアクセス
2. Developer Portal でアプリ作成
3. Keys and tokens → Bearer Token
4. Regenerate して取得

### 11.2 日常運用

#### 11.2.1 監視項目

**システム監視**:
```bash
# プロセス監視
ps aux | grep main.py

# CPU/メモリ使用率
top -p $(pgrep -f main.py)

# ディスク使用量
df -h
```

**ログ監視**:
```bash
# エラーの監視
tail -f app.log | grep ERROR

# 本日の処理件数
grep "記事数:" app.log | grep "$(date +%Y-%m-%d)"
```

#### 11.2.2 定期メンテナンス

**週次タスク**:
- ログファイルのローテーション
- エラーログの確認と対処
- API使用量の確認

**月次タスク**:
- パッケージの更新確認
- パフォーマンスレビュー
- RSSフィードの有効性確認

**四半期タスク**:
- APIキーのローテーション
- セキュリティ監査
- 設定の見直し

### 11.3 トラブルシューティング

#### 11.3.1 よくある問題と解決方法

**問題1: 記事が取得できない**
```
症状: RSS記事数: 0
原因: 
- RSSフィードのURL変更
- ネットワーク接続問題
- フィードの配信停止

解決方法:
1. RSS URLの有効性確認
   curl -I https://example.com/rss
2. 別のフィードを追加
3. プロキシ設定の確認
```

**問題2: AI要約が生成されない**
```
症状: 要約生成に失敗しました
原因:
- APIキーの期限切れ
- レート制限
- OpenAIサービス障害

解決方法:
1. APIキーの確認
2. 使用量の確認（OpenAIダッシュボード）
3. https://status.openai.com でサービス状態確認
```

**問題3: Teams通知が届かない**
```
症状: Teams通知に失敗しました
原因:
- Webhook URLの無効化
- ネットワークポリシー
- Teamsサービス障害

解決方法:
1. Webhook URLの再生成
2. ファイアウォール設定確認
3. 別のチャネルでテスト
```

#### 11.3.2 ログから問題を特定する方法

**エラーパターンと対処**:
```bash
# ネットワークエラー
grep "ConnectionError\|TimeoutError" app.log
→ ネットワーク設定、プロキシ確認

# 認証エラー
grep "401\|403\|Authentication" app.log
→ 各種トークン、APIキーの確認

# レート制限
grep "429\|Rate limit" app.log
→ API使用量確認、実行頻度の調整
```

### 11.4 バックアップとリストア

#### 11.4.1 バックアップ対象

**設定ファイル**:
```bash
# バックアップスクリプト
#!/bin/bash
BACKUP_DIR="/backup/dx-news/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR
cp .env $BACKUP_DIR/
cp requirements.txt $BACKUP_DIR/
tar -czf $BACKUP_DIR/utils.tar.gz utils/
```

**重要度別バックアップ**:
- 🔴 最重要: .env（認証情報）
- 🟡 重要: カスタマイズしたスクリプト
- 🟢 推奨: ログファイル（障害分析用）

#### 11.4.2 リストア手順

1. Pythonアプリケーションの再インストール
2. バックアップから.envをリストア
3. 依存パッケージの再インストール
4. 動作確認

### 11.5 アップグレード

#### 11.5.1 マイナーアップデート

**パッケージ更新**:
```bash
# 個別更新
pip install --upgrade openai

# 一括更新（慎重に）
pip install --upgrade -r requirements.txt
```

#### 11.5.2 メジャーアップデート

**事前準備**:
1. 現在の環境のバックアップ
2. テスト環境での動作確認
3. APIの仕様変更確認
4. 移行計画の作成

**移行手順**:
1. メンテナンス時間の告知
2. 現行システムの停止
3. バックアップ実行
4. 新バージョンのデプロイ
5. 動作確認
6. 問題があれば切り戻し

---

## 12. 用語集

### 12.1 技術用語

**API（Application Programming Interface）**
- 意味: アプリケーション間でデータをやり取りするための仕組み
- 本システムでの使用: OpenAI、Twitter、noteとの通信

**RSS（Really Simple Syndication）**
- 意味: ウェブサイトの更新情報を配信するための形式
- 本システムでの使用: ニュースサイトからの記事取得

**Webhook（ウェブフック）**
- 意味: あるシステムから別のシステムへ自動的にデータを送信する仕組み
- 本システムでの使用: Teamsへの通知

**トークン（Token）**
- 意味: システムにアクセスするための認証情報
- 本システムでの使用: 各種APIの認証

**クラスタリング（Clustering）**
- 意味: 類似したデータをグループ化する手法
- 本システムでの使用: 重複記事の除去

**Markdown（マークダウン）**
- 意味: 簡単な記法で文書を装飾できる軽量マークアップ言語
- 本システムでの使用: Teams投稿のフォーマット

### 12.2 ビジネス用語

**DX（Digital Transformation）**
- 意味: デジタル技術を活用してビジネスを変革すること
- 重要性: 競争力維持、業務効率化、新価値創造

**生成AI（Generative AI）**
- 意味: 新しいコンテンツを生成できるAI技術
- 例: ChatGPT、DALL-E、Midjourney

**BIツール（Business Intelligence Tool）**
- 意味: ビジネスデータを分析・可視化するツール
- 例: Tableau、Power BI、Looker

### 12.3 システム固有用語

**run-now オプション**
- 意味: スケジュールを待たずに即座に実行するオプション
- 使用場面: テスト実行、臨時実行

**post オプション**
- 意味: SNSへの実投稿を有効にするオプション
- 注意: 本番環境でのみ使用推奨

**utils モジュール**
- 意味: 各種ユーティリティ機能をまとめたパッケージ
- 内容: RSS処理、AI連携、SNS投稿など

---

## 13. 付録

### 13.1 設定テンプレート

#### 13.1.1 .env.example

```bash
# ====================
# 必須設定
# ====================

# OpenAI API キー
# 取得方法: https://platform.openai.com/api-keys
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Microsoft Teams Webhook URL
# 設定方法: Teamsチャネル → コネクタ → Incoming Webhook
TEAM_WEBHOOK_URL=https://outlook.office.com/webhook/xxxxxxxx

# ====================
# オプション設定
# ====================

# Twitter Bearer Token（Twitter投稿を使用する場合）
# 取得方法: https://developer.twitter.com
TWITTER_BEARER_TOKEN=

# note アクセストークン（note投稿を使用する場合）
# 取得方法: noteの開発者向けドキュメント参照
NOTE_TOKEN=

# ====================
# スケジュール設定
# ====================

# 実行曜日（mon, tue, wed, thu, fri, sat, sun）
POST_DAY_OF_WEEK=mon

# 実行時刻（24時間表記: 00-23）
POST_HOUR_24=09

# ====================
# データソース設定
# ====================

# RSS フィードURL（カンマ区切りで複数指定可能）
RSS_FEEDS=https://techcrunch.com/feed/,https://gigazine.net/news/rss_2.0/,https://jp.techcrunch.com/feed/

# フィルタリングキーワード（カンマ区切り）
KEYWORDS=生成AI,BIツール,DX,ChatGPT,機械学習,データ分析,RPA,IoT,ブロックチェーン
```

### 13.2 運用チェックリスト

#### 13.2.1 日次チェック項目

- [ ] プロセスが正常に動作しているか
- [ ] エラーログの有無
- [ ] Teams通知が届いているか
- [ ] API使用量の確認

#### 13.2.2 週次チェック項目

- [ ] ログファイルのサイズ確認
- [ ] RSS フィードの有効性
- [ ] 要約品質の確認
- [ ] SNS投稿内容の確認（使用時）

#### 13.2.3 月次チェック項目

- [ ] パッケージの更新確認
- [ ] セキュリティパッチの適用
- [ ] APIコストの確認
- [ ] パフォーマンスメトリクスの確認

### 13.3 トラブル時の連絡先

#### 13.3.1 外部サービスサポート

**OpenAI**
- ステータスページ: https://status.openai.com
- サポート: https://help.openai.com

**Microsoft Teams**
- ステータスページ: https://admin.microsoft.com/ServiceHealth
- サポート: 組織のIT管理者に連絡

**Twitter/X**
- ステータスページ: https://api.twitterstat.us
- 開発者フォーラム: https://twittercommunity.com

### 13.4 パフォーマンスチューニング

#### 13.4.1 処理速度の改善

**並列処理の活用**:
```python
# 将来の改善案：RSS取得の並列化
import concurrent.futures

def fetch_parallel(urls):
    with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
        results = executor.map(parse_rss_feed, urls)
    return list(results)
```

**キャッシュの活用**:
- RSS フィードの一時保存
- 要約結果のキャッシュ
- API レスポンスの再利用

#### 13.4.2 コスト最適化

**OpenAI API コスト削減**:
1. モデル選択の最適化（gpt-4o-mini推奨）
2. プロンプトの簡潔化
3. 不要な要約の除外
4. バッチ処理の活用

**概算コスト**:
- 1記事あたり: 約500トークン
- 1000トークンあたり: $0.002
- 月20記事×4週: 約$0.16

### 13.5 今後の拡張案

#### 13.5.1 機能拡張のアイデア

1. **多言語対応**
   - 英語記事の自動翻訳
   - 多言語での要約生成

2. **データソース拡張**
   - NewsAPI の統合
   - Webスクレイピング機能
   - ソーシャルメディアトレンド

3. **分析機能**
   - トレンド分析
   - 感情分析
   - 競合分析レポート

4. **通知先拡張**
   - Slack連携
   - メール配信
   - LINE通知

5. **UI/UX改善**
   - Web管理画面
   - 配信内容のプレビュー
   - 設定のGUI化

---

## 終わりに

本設計仕様書は、DXニュース自動収集・配信アプリの全容を詳細に記述したものです。システムの導入、運用、保守において必要な情報を網羅的に提供することを目指しました。

本システムを通じて、組織のDX推進と情報共有の効率化に貢献できることを願っています。

ご不明な点やご要望がございましたら、システム管理者までお問い合わせください。

---

**文書情報**
- バージョン: 1.0.0
- 作成日: 2024年1月15日
- 最終更新日: 2024年1月15日
- 作成者: DXニュース配信システム開発チーム