name: Test Setup and Configuration

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ãƒ†ã‚¹ãƒˆã®ç¨®é¡'
        required: true
        default: 'basic'
        type: choice
        options:
        - 'basic'        # åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ
        - 'rss'          # RSSå–å¾—ãƒ†ã‚¹ãƒˆ
        - 'llm'          # LLMæ¥ç¶šãƒ†ã‚¹ãƒˆ
        - 'notifications' # é€šçŸ¥ãƒ†ã‚¹ãƒˆ

jobs:
  test-configuration:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test basic configuration
      if: github.event.inputs.test_type == 'basic'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        RSS_FEEDS: ${{ secrets.RSS_FEEDS }}
        KEYWORDS: ${{ secrets.KEYWORDS }}
      run: |
        echo "ğŸ”§ åŸºæœ¬è¨­å®šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™..."
        
        # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        echo "âœ… ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"
        echo "OPENAI_API_KEY: $(if [ -n "$OPENAI_API_KEY" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
        echo "RSS_FEEDS: $(if [ -n "$RSS_FEEDS" ]; then echo "è¨­å®šæ¸ˆã¿ ($RSS_FEEDS)"; else echo "æœªè¨­å®š"; fi)"
        echo "KEYWORDS: $(if [ -n "$KEYWORDS" ]; then echo "è¨­å®šæ¸ˆã¿ ($KEYWORDS)"; else echo "æœªè¨­å®š"; fi)"
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        python -c "
        from config import CONFIG
        if CONFIG:
            print('âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿: æˆåŠŸ')
            print(f'RSS Feeds: {len(CONFIG.rss_feeds)}ä»¶')
            print(f'Keywords: {len(CONFIG.keywords)}ä»¶')
        else:
            print('âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿: å¤±æ•—')
            exit(1)
        "
    
    - name: Test RSS feeds
      if: github.event.inputs.test_type == 'rss'
      env:
        RSS_FEEDS: ${{ secrets.RSS_FEEDS }}
        KEYWORDS: ${{ secrets.KEYWORDS }}
      run: |
        echo "ğŸ“¡ RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™..."
        python -c "
        from utils import rss
        from config import CONFIG
        
        try:
            articles = rss.fetch_articles(CONFIG.rss_feeds, days=1, keywords=CONFIG.keywords)
            print(f'âœ… RSSå–å¾—: æˆåŠŸ ({len(articles)}ä»¶ã®è¨˜äº‹ã‚’å–å¾—)')
            
            if articles:
                print('ğŸ“„ å–å¾—ã—ãŸè¨˜äº‹ã®ä¾‹:')
                for i, article in enumerate(articles[:3], 1):
                    print(f'{i}. {article.get(\"title\", \"ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜\")}')
            else:
                print('âš ï¸  è¨˜äº‹ãŒå–å¾—ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ')
        except Exception as e:
            print(f'âŒ RSSå–å¾—: å¤±æ•— - {e}')
            exit(1)
        "
    
    - name: Test LLM connection
      if: github.event.inputs.test_type == 'llm'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "ğŸ¤– LLMæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™..."
        python -c "
        from utils import llm as llm_module
        from config import CONFIG
        
        try:
            client = llm_module.LLMClient(api_key=CONFIG.openai_api_key)
            test_summary = client.summarize('ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç”¨ã®è¨˜äº‹ã§ã™ã€‚AIæŠ€è¡“ã®é€²æ­©ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚', max_chars=50)
            print(f'âœ… LLMæ¥ç¶š: æˆåŠŸ')
            print(f'ãƒ†ã‚¹ãƒˆè¦ç´„: {test_summary}')
        except Exception as e:
            print(f'âŒ LLMæ¥ç¶š: å¤±æ•— - {e}')
            exit(1)
        "
    
    - name: Test notifications
      if: github.event.inputs.test_type == 'notifications'
      env:
        TEAM_WEBHOOK_URL: ${{ secrets.TEAM_WEBHOOK_URL }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
      run: |
        echo "ğŸ“¢ é€šçŸ¥è¨­å®šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™..."
        
        # Teams
        if [ -n "$TEAM_WEBHOOK_URL" ]; then
          echo "âœ… Teams Webhook: è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸  Teams Webhook: æœªè¨­å®š"
        fi
        
        # Email
        if [ -n "$SMTP_SERVER" ]; then
          echo "âœ… Email (SMTP): è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸  Email (SMTP): æœªè¨­å®š"
        fi
        
        # LINE
        if [ -n "$LINE_CHANNEL_ACCESS_TOKEN" ]; then
          echo "âœ… LINE Bot: è¨­å®šæ¸ˆã¿"
        else
          echo "âš ï¸  LINE Bot: æœªè¨­å®š"
        fi
    
    - name: Generate test report
      if: always()
      run: |
        echo "## ğŸ§ª è¨­å®šãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ãƒ†ã‚¹ãƒˆç¨®é¡" >> $GITHUB_STEP_SUMMARY
        echo "${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å®Ÿè¡Œæ™‚åˆ»" >> $GITHUB_STEP_SUMMARY
        echo "- UTC: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- JST: $(TZ=Asia/Tokyo date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã¯ã€æ—¥æ¬¡å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "å¤±æ•—ã—ãŸå ´åˆã¯ã€GitHub Secretsã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
    
    - name: Create test artifacts
      run: |
        mkdir -p test-results
        echo "Test Type: ${{ github.event.inputs.test_type }}" > test-results/test-info.txt
        echo "Date: $(date)" >> test-results/test-info.txt
        echo "Status: $(if [ $? -eq 0 ]; then echo 'SUCCESS'; else echo 'FAILED'; fi)" >> test-results/test-info.txt
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.event.inputs.test_type }}-${{ github.run_number }}
        path: test-results/
        retention-days: 7