name: Daily DX News Collection

on:
  # æ¯Žæ—¥æœ8æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ = UTC 23æ™‚ï¼ˆå‰æ—¥ï¼‰
  schedule:
    - cron: '45 1 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      post_to_social:
        description: 'SNSã«å®Ÿéš›ã«æŠ•ç¨¿ã™ã‚‹ã‹'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  collect-daily-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create output directory
      run: mkdir -p outputs
    
    - name: Run daily news collection
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        RSS_FEEDS: ${{ secrets.RSS_FEEDS }}
        KEYWORDS: ${{ secrets.KEYWORDS }}
        TEAM_WEBHOOK_URL: ${{ secrets.TEAM_WEBHOOK_URL }}
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        NOTE_TOKEN: ${{ secrets.NOTE_TOKEN }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_IDS: ${{ secrets.LINE_USER_IDS }}
        OUTPUT_DIR: outputs
        POST_DAY_OF_WEEK: mon
        POST_HOUR_24: 8
      run: |
        if [ "${{ github.event.inputs.post_to_social }}" = "true" ]; then
          echo "ðŸš€ SNSã«å®Ÿéš›ã«æŠ•ç¨¿ã—ã¾ã™"
          python main.py --run-now --post
        else
          echo "ðŸ“ æŠ•ç¨¿æ¡ˆã®ã¿ç”Ÿæˆã—ã¾ã™ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰"
          python main.py --run-now
        fi
    
    - name: Check output files
      run: |
        echo "ðŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
        find outputs -type f -name "*.txt" -o -name "*.md" -o -name "*.json" | head -20
        
        echo ""
        echo "ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«æ•°çµ±è¨ˆ:"
        echo "ãƒ„ã‚¤ãƒ¼ãƒˆæ¡ˆ: $(find outputs -name "tweet_*.txt" | wc -l)ä»¶"
        echo "noteè¨˜äº‹æ¡ˆ: $(find outputs -name "note_*.md" | wc -l)ä»¶"
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«: $(find outputs -name "*.json" | wc -l)ä»¶"
    
    - name: Upload daily news artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: daily-news-${{ github.run_number }}
        path: outputs/
        retention-days: 30
    
    - name: Upload logs on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          *.log
          outputs/
        retention-days: 7
    
    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ“Š æ—¥æ¬¡ãƒ‹ãƒ¥ãƒ¼ã‚¹åŽé›†çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„" >> $GITHUB_STEP_SUMMARY
        echo "- ãƒ„ã‚¤ãƒ¼ãƒˆæ¡ˆ: $(find outputs -name "tweet_*.txt" 2>/dev/null | wc -l)ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- noteè¨˜äº‹æ¡ˆ: $(find outputs -name "note_*.md" 2>/dev/null | wc -l)ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- åŽé›†è¨˜äº‹æ•°: $(find outputs -name "articles.json" -exec jq '.articles | length' {} \; 2>/dev/null | head -1 || echo "0")ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å®Ÿè¡Œæ™‚åˆ»" >> $GITHUB_STEP_SUMMARY
        echo "- UTC: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- JST: $(TZ=Asia/Tokyo date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
        echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
